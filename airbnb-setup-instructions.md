# Инструкция по настройке синхронизации Airbnb

## Текущий статус

✅ **Настроено:**
- Комната: "Second floor (entire) — Queen bed"
- iCal URL: `https://www.airbnb.ca/calendar/ical/49811499.ics?s=6535393c688e058d5e9fec0583e2eea6`

⚠️ **Будет добавлено позже:**
- "Basement — Queen"
- "Ground floor — Queen bed"
- "Ground floor — Twin beds"

## Как добавить новые комнаты

Когда вы добавите другие комнаты на Airbnb:

1. Получите iCal URL для каждой комнаты (см. `airbnb-ical-setup-guide.md`)
2. Откройте файл `config.php`
3. Найдите массив `$AIRBNB_ICAL_URLS`
4. Добавьте или обновите строку:
   ```php
   'Basement — Queen' => 'https://www.airbnb.ca/calendar/ical/НОВЫЙ_ID.ics?s=...',
   ```
5. Сохраните файл и загрузите на хостинг

## Автоматическая синхронизация

### Вариант 1: Через Cron (рекомендуется)

Если у вас есть доступ к cron на хостинге:

1. Откройте crontab: `crontab -e`
2. Добавьте строку для синхронизации каждый час:
   ```
   0 * * * * /usr/bin/php /path/to/your/site/cron_sync_airbnb.php
   ```
   Или один раз в день в 2:00 ночи:
   ```
   0 2 * * * /usr/bin/php /path/to/your/site/cron_sync_airbnb.php
   ```

3. Замените `/path/to/your/site/` на реальный путь к вашему сайту

### Вариант 2: Через веб-запрос

Если cron недоступен, можно использовать внешний сервис (например, EasyCron):

1. Откройте файл `cron_sync_airbnb.php`
2. Найдите строку: `$expectedToken = 'your-secret-token-here';`
3. Замените на безопасный токен (например, случайную строку)
4. Настройте внешний сервис для запроса:
   ```
   https://your-site.com/cron_sync_airbnb.php?token=ВАШ_ТОКЕН
   ```
5. Установите расписание (например, каждый час)

### Вариант 3: Ручная синхронизация

Всегда можно синхронизировать вручную:

1. Войдите в админ-панель
2. Перейдите в раздел "Calendar"
3. Нажмите кнопку "Sync with Airbnb"
4. Дождитесь завершения синхронизации

## Как это работает

1. **Синхронизация:** Система загружает iCal календарь от Airbnb, парсит его и сохраняет занятые даты в базу данных
2. **Проверка доступности:** При создании бронирования система проверяет:
   - Не занято ли в Airbnb
   - Нет ли ручных блокировок
   - Нет ли существующих бронирований
3. **Календарь:** В админ-панели и на страницах комнат отображаются:
   - Доступные даты (зеленые)
   - Забронированные даты (красные)
   - Заблокированные даты (серые, включая Airbnb)

## Важные замечания

⚠️ **Безопасность:**
- iCal URL содержит идентификаторы вашего Airbnb аккаунта
- Не публикуйте эти URL публично
- Они хранятся только в `config.php` на сервере

⚠️ **Синхронизация:**
- Первая синхронизация может занять несколько минут
- Последующие синхронизации быстрее (только обновление изменений)
- Рекомендуется синхронизировать хотя бы раз в день

⚠️ **Ошибки:**
- Если синхронизация не работает, проверьте:
  1. Правильность iCal URL в `config.php`
  2. Доступность URL (можно открыть в браузере)
  3. Логи ошибок на сервере

## Тестирование

После добавления новых комнат:

1. Выполните ручную синхронизацию через админ-панель
2. Проверьте календарь в разделе "Calendar"
3. Создайте тестовое бронирование на занятую дату - должно быть отклонено
4. Проверьте доступность дат на странице комнаты



