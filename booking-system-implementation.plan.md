<!-- 30bd0180-9571-4ec1-bb5c-ce5ccc42437b e32a32f4-5ae0-4519-aefd-991603c9010f -->
# План реализации системы бронирования

## Обзор

Преобразование текущих форм бронирования-заглушек в полнофункциональную систему бронирования с серверным хранилищем, синхронизацией календаря Airbnb, email-уведомлениями, обработкой платежей и подтверждением администратором.

## Анализ текущего состояния

- **Frontend**: Формы существуют на страницах комнат (`room-basement.html`, `room-first-double.html` и т.д.), но только сохраняют в `localStorage` и показывают алерты
- **Backend**: Инфраструктура PHP/MySQL существует (`api.php`, `common.php`, `config.php`), но нет эндпоинтов для бронирований
- **Админ-панель**: Базовый CRUD для контента/комнат существует (`admin.html`, `admin.js`)
- **База данных**: Подключение настроено, но нет таблицы `bookings`

## План реализации

### Фаза 1: Схема базы данных и базовый API бронирований

#### 1.1 Создание таблиц базы данных

**Файл**: `database_schema.sql` (новый)

- Таблица `bookings`: `id`, `room_name`, `checkin_date`, `checkout_date`, `guest_name`, `email`, `phone`, `guests_count`, `pets`, `status` (pending/confirmed/cancelled), `payment_status`, `payment_intent_id`, `total_amount`, `currency`, `stripe_payment_id`, `airbnb_synced`, `created_at`, `updated_at`
- Таблица `blocked_dates`: `id`, `room_name`, `blocked_date`, `reason`, `created_at` (для ручной блокировки дат)
- Таблица `airbnb_calendar`: `id`, `room_name`, `date`, `is_available`, `last_synced_at` (для кэширования синхронизации Airbnb)
- Таблица `booking_confirmations`: `id`, `booking_id`, `confirmation_code`, `email_sent_at`, `host_confirmed_at`

#### 1.2 API эндпоинты для бронирований

**Файл**: `api.php` (расширить)

- `create_booking`: Проверить доступность, проверить синхронизацию Airbnb, создать запись бронирования, отправить подтверждающее письмо, вернуть ID бронирования
- `get_booking`: Получить бронирование по ID
- `check_availability`: Проверить доступность дат для комнаты (учитывать заблокированные даты + синхронизацию Airbnb + существующие бронирования)
- `confirm_booking`: Админ-эндпоинт для подтверждения бронирования
- `cancel_booking`: Отменить бронирование (логика возврата средств, если оплачено)
- `get_bookings`: Админ-эндпоинт для списка всех бронирований с фильтрами

**Файл**: `booking_api.php` (новый)

- Вынести всю логику API бронирований в отдельный файл
- Обработка проверки доступности с синхронизацией Airbnb
- Создание payment intent для Stripe

### Фаза 2: Интеграция email-системы (SendGrid)

#### 2.1 Конфигурация SendGrid

**Файл**: `config.php` (расширить)

- Добавить константу `SENDGRID_API_KEY`
- Добавить конфигурацию шаблонов email

#### 2.2 Email-сервис

**Файл**: `email_service.php` (новый)

- `sendBookingConfirmation($booking)`: Отправить подтверждение гостю
- `sendBookingRequestToHost($booking)`: Уведомить хозяина о новом запросе на бронирование
- `sendBookingConfirmedToGuest($booking)`: Отправить подтверждение после одобрения хозяином
- `sendBookingCancelled($booking)`: Отправить уведомление об отмене
- Использовать PHP библиотеку SendGrid для надежной доставки

#### 2.3 Шаблоны email

**Файлы**: `templates/email_booking_confirmation.html`, `templates/email_booking_request.html` и т.д. (новые)

- Профессиональные HTML-шаблоны писем
- Включить детали бронирования, коды подтверждения, ссылки на оплату

### Фаза 3: Интеграция платежей (Stripe)

#### 3.1 Конфигурация Stripe

**Файл**: `config.php` (расширить)

- Добавить константы `STRIPE_SECRET_KEY` и `STRIPE_PUBLISHABLE_KEY`
- Добавить секрет для webhook событий платежей

#### 3.2 Платежный сервис

**Файл**: `payment_service.php` (новый)

- `createPaymentIntent($booking)`: Создать Stripe payment intent
- `processPayment($paymentIntentId)`: Обработать платеж
- `refundPayment($bookingId)`: Обработать возвраты при отменах
- Обработчик webhook для событий платежей (`stripe_webhook.php`)

#### 3.3 Интеграция платежей на фронтенде

**Файлы**: Обновить `script.js`, создать `payment.js` (новый)

- Загрузить Stripe.js на страницах бронирования
- Создать форму оплаты с Stripe Elements
- Обработать отправку платежа и редирект
- Показать статус оплаты в подтверждении бронирования

### Фаза 4: Синхронизация календаря Airbnb

#### 4.1 Сервис синхронизации iCal

**Файл**: `airbnb_sync.php` (новый)

- `fetchAirbnbCalendar($icalUrl)`: Парсить iCal feed от Airbnb
- `syncAirbnbToDatabase($roomName, $icalData)`: Обновить таблицу `airbnb_calendar`
- `checkDateAvailability($roomName, $date)`: Проверить доступность даты с учетом синхронизации Airbnb
- Планируемая синхронизация (через cron или ручной запуск)

#### 4.2 Парсер iCal

**Файл**: `ical_parser.php` (новый)

- Парсить iCal формат из экспорта Airbnb
- Извлекать заблокированные/забронированные даты
- Обрабатывать конвертацию часовых поясов

#### 4.3 Управление календарем в админ-панели

**Файл**: `admin.js` (расширить)

- Добавить раздел "Управление календарем"
- Показать вид календаря с синхронизированными датами Airbnb
- Разрешить ручную блокировку/разблокировку дат
- Отображать существующие бронирования на календаре

### Фаза 5: Фронтенд процесс бронирования

#### 5.1 Обновление форм бронирования

**Файлы**: Обновить `script.js` (обработчики форм бронирования)

- Заменить сохранение в `localStorage` на вызовы API
- Добавить проверку доступности перед отправкой формы
- Показывать состояния загрузки во время вызовов API
- Обрабатывать ошибки API корректно
- Редирект на страницу оплаты после успешного создания бронирования

#### 5.2 Страница подтверждения бронирования

**Файл**: `booking-confirmation.html` (новый)

- Отобразить детали бронирования
- Показать форму оплаты (если не оплачено)
- Отобразить код подтверждения
- Ссылка на панель гостя

#### 5.3 Виджет календаря доступности

**Файл**: `availability-calendar.js` (новый)

- Показать доступные даты на страницах комнат
- Выделить заблокированные/забронированные даты
- Проверка доступности в реальном времени

### Фаза 6: Улучшения админ-панели

#### 6.1 Раздел управления бронированиями

**Файл**: `admin.html` (расширить)

- Добавить раздел "Бронирования" в навигацию
- Создать список бронирований с фильтрами (статус, диапазон дат, комната)
- Детальный вид бронирования с информацией о госте, статусом оплаты
- Действия подтверждения/отмены с диалогами подтверждения

**Файл**: `admin.js` (расширить)

- `loadBookingsData()`: Загрузить и отобразить бронирования
- `confirmBooking(bookingId)`: Подтвердить бронирование и отправить письмо
- `cancelBooking(bookingId)`: Отменить с опцией возврата средств
- Календарный вид для всех комнат с наложением бронирований

#### 6.2 UI управления календарем

**Файл**: `admin.html` (расширить)

- Компонент календаря
- Интерфейс ручной блокировки дат
- Индикатор статуса синхронизации Airbnb
- Кнопка ручного запуска синхронизации

### Фаза 7: Webhook и фоновые задачи

#### 7.1 Обработчик Stripe Webhook

**Файл**: `stripe_webhook.php` (новый)

- Обрабатывать события `payment_intent.succeeded`
- Обновлять статус оплаты бронирования
- Отправлять подтверждающие письма
- Логировать события платежей

#### 7.2 Планируемые задачи

**Файл**: `cron_sync_airbnb.php` (новый)

- Планируемая синхронизация календаря Airbnb (ежедневно/ежечасно)
- Обновление кэша доступности
- Отправка отчетов о статусе синхронизации

### Фаза 8: Тестирование и безопасность

#### 8.1 Улучшения безопасности

- Валидация и санитизация ввода (уже есть в `common.php`)
- CSRF защита для создания бронирований
- Ограничение частоты запросов для API бронирований
- Безопасная обработка платежей (никогда не раскрывать секретные ключи)

#### 8.2 Обработка ошибок

- Комплексное логирование ошибок
- Понятные пользователю сообщения об ошибках
- Резервные механизмы для сбоев email/платежей

## Технические решения

### Email-сервис: SendGrid

- **Причина**: Популярный, надежный, отличная доставляемость, бесплатный тариф (100 писем/день), хорошая поддержка в Канаде
- **Реализация**: Использовать PHP библиотеку SendGrid через Composer или прямые вызовы API

### Платежная система: Stripe

- **Причина**: Наиболее популярна в Канаде, отличный опыт разработки, нативная поддержка валюты CAD, обработка налогов, сильная защита от мошенничества
- **Реализация**: Stripe Checkout или Stripe Elements для кастомного UI

### Синхронизация Airbnb: iCal Feed

- **Причина**: Универсальный стандарт, не требует официального партнерства API, Airbnb поддерживает экспорт iCal
- **Реализация**: Парсить iCal файлы, кэшировать в базе данных, синхронизировать по расписанию

## Зависимости для добавления

- SendGrid PHP SDK (через Composer)
- Stripe PHP SDK (через Composer)
- iCal parser библиотека (например, `kigkonsult/icalcreator`)

## Файлы для создания/изменения

### Новые файлы:

- `database_schema.sql`
- `booking_api.php`
- `email_service.php`
- `payment_service.php`
- `airbnb_sync.php`
- `ical_parser.php`
- `stripe_webhook.php`
- `cron_sync_airbnb.php`
- `payment.js`
- `availability-calendar.js`
- `booking-confirmation.html`
- Шаблоны email в папке `templates/`

### Файлы для изменения:

- `api.php` - Добавить маршрутизацию эндпоинтов бронирований
- `config.php` - Добавить ключи SendGrid и Stripe
- `script.js` - Заменить сохранение бронирований в localStorage на вызовы API
- `admin.html` - Добавить разделы бронирований и календаря
- `admin.js` - Добавить функции управления бронированиями
- Страницы бронирования комнат - Добавить проверку доступности и процесс оплаты

