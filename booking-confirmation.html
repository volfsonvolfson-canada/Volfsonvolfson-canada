<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Booking Confirmation — Back to Base</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script>
    (function() {
      const savedTheme = localStorage.getItem('btb_theme');
      const userSetTheme = localStorage.getItem('btb_theme_user') === '1';
      const initialTheme = userSetTheme && savedTheme ? savedTheme : 'dark';
      document.documentElement.setAttribute('data-theme', initialTheme);
    })();
  </script>
  <link rel="stylesheet" href="styles.css">
  <style>
    .confirmation-code {
      font-size: 32px;
      font-weight: bold;
      color: var(--text-primary);
      letter-spacing: 3px;
      text-align: center;
      padding: 20px;
      background: var(--bg-secondary);
      border: 2px dashed var(--border-color);
      border-radius: 8px;
      margin: 20px 0;
    }
    .booking-status {
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
      text-align: center;
    }
    .booking-status.pending {
      background-color: #fed7d7;
      border: 1px solid #e53e3e;
      color: #e53e3e;
    }
    .booking-status.confirmed {
      background-color: #c6f6d5;
      border: 1px solid #38a169;
      color: #2f855a;
    }
    .booking-status.paid {
      background-color: #bee3f8;
      border: 1px solid #3182ce;
      color: #2c5282;
    }
    .payment-section {
      margin-top: 30px;
      padding: 20px;
      background: var(--bg-secondary);
      border-radius: 8px;
    }
    #payment-element {
      margin: 20px 0;
    }
    .payment-error {
      background-color: #fed7d7;
      border: 1px solid #e53e3e;
      color: #e53e3e;
      padding: 12px;
      border-radius: 8px;
      margin: 15px 0;
    }
    .booking-details-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }
    .booking-detail-item {
      padding: 15px;
      background: var(--bg-secondary);
      border-radius: 8px;
    }
    .booking-detail-label {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 5px;
    }
    .booking-detail-value {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
    }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="container header-inner">
      <a class="logo" href="index.html">
        <img alt="Back to Base" class="logo-img" />
        <span class="logo-text">Back to Base</span>
      </a>
      <nav class="nav">
        <a href="index.html#rooms">Rooms</a>
        <a href="massage.html">Massage</a>
        <a href="yoga.html">Yoga</a>
        <a href="special.html">Special</a>
        <a href="about.html">About us</a>
      </nav>
      <div class="header-actions">
        <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
          <svg class="theme-toggle-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 3v1m0 16v1m9-9h1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <span id="theme-text">Light</span>
        </button>
        <a href="login.html" class="btn-signin" id="header-signin">Sign In</a>
      </div>
    </div>
  </header>

  <div class="page-header">
    <div class="container">
      <div class="breadcrumbs"><a href="index.html">Home</a> / Booking Confirmation</div>
      <h1>Booking Confirmation</h1>
      <p class="section-lead">Your booking request has been received. Please review the details below.</p>
    </div>
  </div>

  <main class="section">
    <div class="container">
      <!-- Загрузка данных -->
      <div id="loading-message" class="card" style="text-align: center; padding: 40px;">
        <p>Loading booking details...</p>
      </div>

      <!-- Ошибка загрузки -->
      <div id="error-message" class="card" style="display: none; background-color: #fed7d7; border: 1px solid #e53e3e; color: #e53e3e;">
        <h2>Error</h2>
        <p id="error-text"></p>
        <p style="margin-top: 20px;">
          <a href="index.html" class="btn primary">Back to Home</a>
        </p>
      </div>

      <!-- Контент подтверждения -->
      <div id="confirmation-content" style="display: none;">
        <!-- Код подтверждения -->
        <section class="card">
          <h2>Confirmation Code</h2>
          <div class="confirmation-code" id="confirmation-code">—</div>
          <p style="text-align: center; color: var(--text-secondary); margin-top: 10px;">
            Please save this code for your records. You will also receive it via email.
          </p>
        </section>

        <!-- Статус бронирования -->
        <section class="card" style="margin-top: 20px;">
          <div class="booking-status" id="booking-status">Pending</div>
        </section>

        <!-- Детали бронирования -->
        <section class="card" style="margin-top: 20px;">
          <h2>Booking Details</h2>
          <div class="booking-details-grid">
            <div class="booking-detail-item">
              <div class="booking-detail-label">Room</div>
              <div class="booking-detail-value" id="booking-room">—</div>
            </div>
            <div class="booking-detail-item">
              <div class="booking-detail-label">Check-in</div>
              <div class="booking-detail-value" id="booking-checkin">—</div>
            </div>
            <div class="booking-detail-item">
              <div class="booking-detail-label">Check-out</div>
              <div class="booking-detail-value" id="booking-checkout">—</div>
            </div>
            <div class="booking-detail-item">
              <div class="booking-detail-label">Guests</div>
              <div class="booking-detail-value" id="booking-guests">—</div>
            </div>
            <div class="booking-detail-item">
              <div class="booking-detail-label">Pets</div>
              <div class="booking-detail-value" id="booking-pets">—</div>
            </div>
            <div class="booking-detail-item">
              <div class="booking-detail-label">Total Amount</div>
              <div class="booking-detail-value" id="booking-total">—</div>
            </div>
          </div>
        </section>

        <!-- Информация о госте -->
        <section class="card" style="margin-top: 20px;">
          <h2>Guest Information</h2>
          <div class="booking-details-grid">
            <div class="booking-detail-item">
              <div class="booking-detail-label">Name</div>
              <div class="booking-detail-value" id="guest-name">—</div>
            </div>
            <div class="booking-detail-item">
              <div class="booking-detail-label">Email</div>
              <div class="booking-detail-value" id="guest-email">—</div>
            </div>
            <div class="booking-detail-item">
              <div class="booking-detail-label">Phone</div>
              <div class="booking-detail-value" id="guest-phone">—</div>
            </div>
          </div>
        </section>

        <!-- Раздел оплаты (если требуется) -->
        <section class="card payment-section" id="payment-section" style="display: none; margin-top: 20px;">
          <h2>Payment</h2>
          <p>Complete your payment to confirm your booking.</p>
          <form id="payment-form">
            <div id="payment-element"></div>
            <div id="payment-errors" class="payment-error" style="display: none;"></div>
            <button type="submit" id="payment-submit" class="btn primary" style="width: 100%; margin-top: 20px;">
              Pay now
            </button>
          </form>
        </section>

        <!-- Сообщение после успешной оплаты -->
        <section class="card" id="payment-success" style="display: none; margin-top: 20px; background-color: #c6f6d5; border: 1px solid #38a169;">
          <h2 style="color: #2f855a;">Payment Successful!</h2>
          <p style="color: #2f855a;">Your payment has been processed successfully. Your booking is now confirmed.</p>
        </section>

        <!-- Действия -->
        <section class="card" style="margin-top: 20px; text-align: center;">
          <p style="margin-bottom: 20px;">
            <a href="index.html" class="btn">Back to Home</a>
            <a href="order.html" class="btn primary" style="margin-left: 10px;">View My Bookings</a>
          </p>
        </section>
      </div>
    </div>
  </main>

  <footer class="site-footer">
    <div class="container footer-grid">
      <div>
        <h4>Contact</h4>
        <p>British Columbia, Canada</p>
        <p>Phone: +1 (555) 123‑4567</p>
        <p>Email: hello@backtobase.example</p>
      </div>
      <div>
        <h4>Navigation</h4>
        <ul class="footer-nav">
          <li><a href="index.html#rooms">Rooms</a></li>
          <li><a href="massage.html">Massage</a></li>
          <li><a href="yoga.html">Yoga</a></li>
          <li><a href="special.html">Special</a></li>
          <li><a href="about.html">About us</a></li>
        </ul>
      </div>
      <div>
        <h4>Quiet hours</h4>
        <p>22:00 — 07:00</p>
      </div>
    </div>
    <div class="container copyright">© <span id="year"></span> Back to Base</div>
  </footer>

  <script src="script.js"></script>
  <script src="booking.js"></script>
  <script src="payment.js"></script>
  <script>
    (async function() {
      // Получаем код подтверждения из URL или sessionStorage
      const urlParams = new URLSearchParams(window.location.search);
      const confirmationCode = urlParams.get('code') || sessionStorage.getItem('last_confirmation_code');
      const paidParam = urlParams.get('paid') === 'true';

      const loadingEl = document.getElementById('loading-message');
      const errorEl = document.getElementById('error-message');
      const errorTextEl = document.getElementById('error-text');
      const contentEl = document.getElementById('confirmation-content');

      if (!confirmationCode) {
        // Если нет кода подтверждения, пытаемся получить из sessionStorage
        const bookingId = sessionStorage.getItem('last_booking_id');
        if (!bookingId) {
          loadingEl.style.display = 'none';
          errorEl.style.display = 'block';
          errorTextEl.textContent = 'Booking information not found. Please make a booking first.';
          return;
        }
      }

      try {
        // Загружаем данные бронирования
        const bookingResult = await window.BookingAPI.getBooking(confirmationCode || sessionStorage.getItem('last_booking_id'));

        if (!bookingResult.success || !bookingResult.booking) {
          throw new Error(bookingResult.error || 'Booking not found');
        }

        const booking = bookingResult.booking;

        // Скрываем загрузку
        loadingEl.style.display = 'none';

        // Отображаем данные бронирования
        document.getElementById('confirmation-code').textContent = booking.confirmation_code || '—';
        
        // Статус бронирования
        const statusEl = document.getElementById('booking-status');
        statusEl.textContent = booking.status === 'confirmed' ? 'Confirmed' : 
                               booking.status === 'cancelled' ? 'Cancelled' : 'Pending';
        statusEl.className = 'booking-status ' + (booking.status || 'pending');
        if (booking.payment_status === 'paid') {
          statusEl.className += ' paid';
          statusEl.textContent = 'Paid & Confirmed';
        }

        // Детали бронирования
        document.getElementById('booking-room').textContent = booking.room_name || '—';
        document.getElementById('booking-checkin').textContent = formatDate(booking.checkin_date) || '—';
        document.getElementById('booking-checkout').textContent = formatDate(booking.checkout_date) || '—';
        document.getElementById('booking-guests').textContent = booking.guests_count || '—';
        document.getElementById('booking-pets').textContent = booking.pets ? 'Yes' : 'No';
        document.getElementById('booking-total').textContent = 
          (booking.currency || 'CAD') + ' ' + (parseFloat(booking.total_amount || 0).toFixed(2));

        // Информация о госте
        document.getElementById('guest-name').textContent = booking.guest_name || '—';
        document.getElementById('guest-email').textContent = booking.email || '—';
        document.getElementById('guest-phone').textContent = booking.phone || '—';

        // Показываем контент
        contentEl.style.display = 'block';

        // Если требуется оплата и еще не оплачено
        const clientSecret = sessionStorage.getItem('client_secret');
        const paymentIntentId = sessionStorage.getItem('payment_intent_id');
        // Получаем Stripe Publishable Key из config.php (для безопасности лучше получать через API)
        // Пока используем из config.php напрямую (в продакшене лучше получать через API endpoint)
        const stripePublishableKey = 'YOUR_STRIPE_PUBLISHABLE_KEY_HERE'; // TODO: Получать через API endpoint

        if (paidParam || booking.payment_status === 'paid') {
          // Успешная оплата
          document.getElementById('payment-section').style.display = 'none';
          document.getElementById('payment-success').style.display = 'block';
        } else if (clientSecret && booking.payment_status === 'pending' && stripePublishableKey) {
          // Показываем форму оплаты
          document.getElementById('payment-section').style.display = 'block';
          
          // Инициализируем Stripe
          await window.PaymentAPI.initPaymentForm(stripePublishableKey, clientSecret);
        }

      } catch (error) {
        console.error('Load booking error:', error);
        loadingEl.style.display = 'none';
        errorEl.style.display = 'block';
        errorTextEl.textContent = error.message || 'Failed to load booking details';
      }

      // Форматирование даты
      function formatDate(dateString) {
        if (!dateString) return '—';
        try {
          const date = new Date(dateString + 'T00:00:00');
          const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                         'July', 'August', 'September', 'October', 'November', 'December'];
          return `${months[date.getMonth()]} ${String(date.getDate()).padStart(2, '0')}, ${date.getFullYear()}`;
        } catch (e) {
          return dateString;
        }
      }
    })();
  </script>
</body>
</html>

